---
import { SITE_TITLE, SITE_DESCRIPTION, GITHUB_REPOS } from '../consts';

import { AboutHero } from '@/components/sections/about-hero';
import { AboutInvestorsContributors } from '@/components/sections/about-investors-contributors';
import { AboutMissionTeam } from '@/components/sections/about-mission-team';
import { AboutTestimonials } from '@/components/sections/about-testimonials';
import DefaultLayout from '@/layouts/DefaultLayout.astro';

const BOTS = ["actions-user", "Copilot"];

const API_URL = (repo) => `https://api.github.com/repos/${repo}/contributors`;

async function fetchContributors() {
  const opts = { cache: "no-store", headers: { Accept: "application/vnd.github+json" } };
  if (process.env.GITHUB_API_TOKEN) {
    opts.headers.Authorization = `Bearer ${process.env.GITHUB_API_TOKEN}`;
  }

  const res = await Promise.all(GITHUB_REPOS.map(repo => fetch(API_URL(repo), opts)));

  if (res.some(r => !r.ok)) { throw new Error(`GitHub API ${res.status}`); }

  const data = await Promise.all(res.map(r => r.json()));

  return Object.values(data.flatMap(x => x).reduce((acc, entry) => {
    if (BOTS.includes(entry.login)) { return acc; }

    if (!acc[entry.login]) {
      acc[entry.login] = {
        username: entry.login,
        commits: entry.contributions,
        avatar: entry.avatar_url,
        url: entry.html_url,
      };
    } else {
      acc[entry.login].commits += entry.contributions;
    }

    return acc;
  }, {})).sort((a, b) => b.commits - a.commits);
}

const contributors = await fetchContributors();
---

<DefaultLayout title={SITE_TITLE} description={SITE_DESCRIPTION}>
  <div class="overflow-hidden">
    <AboutHero client:load />
    <AboutMissionTeam client:visible />
    <AboutInvestorsContributors client:visible contributors={contributors}/>
    {/* <AboutTestimonials client:visible /> */}
  </div>
</DefaultLayout>
